<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to MazamaLocationUtils • MazamaLocationUtils</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to MazamaLocationUtils">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MazamaLocationUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/MazamaLocationUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/MazamaCoreUtils">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction to MazamaLocationUtils</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">2019-10-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/MazamaCoreUtils/blob/master/vignettes/MazamaLocationUtils.Rmd"><code>vignettes/MazamaLocationUtils.Rmd</code></a></small>
      <div class="hidden name"><code>MazamaLocationUtils.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>This package is intended to be used in support of data management activities associated with fixed locations in space. The motivating fields include both air and water quality monitoring where fixed sensors report at regular time intervals.</p>
<p>When working with environmental monitoring time series, one of the first things you have to do is create unique identifiers for each individual time series. In an ideal world, each environmental time series would have both a <code>locationID</code> and a <code>sensorID</code> that uniquely identify the spatial location and specific instrument making measurements. A unique <code>timeseriesID</code> could be produced as <code>locationID_sensorID</code>. Location metadata associated with each time series would contain basic information needed for downstream analysis including at least:</p>
<p><code>timeseriesID, locationID, sensorID, longitude, latitude, ...</code></p>
<ul>
<li>Multiple sensors placed at a location could be be grouped by <code>locationID</code>.</li>
<li>An extended time series for a mobile sensor would group by <code>sensorID</code>.</li>
<li>Maps would be created using <code>longitude, latitude</code>.</li>
<li>Time series would be accessed from a secondary <code>data</code> table with <code>timeseriesID</code>.</li>
</ul>
<p>Unfortunately, we are rarely supplied with a truly unique and truly spatial <code>locationID</code>. Instead we often use <code>sensorID</code> or an associated non-spatial identifier as a stand-in for <code>locationID</code>.</p>
<p>Complications we have seen include:</p>
<ul>
<li>GPS-reported longitude and latitude can have <em>jitter</em> in the fourth or fifth decimal place making it challenging to use them to create a unique <code>locationID</code>.</li>
<li>Sensors are sometimes <em>repositioned</em> in what the scientist considers the “same location”.</li>
<li>Data for a single sensor goes through different processing pipelines using different identifiers and is later brought together as two separate timeseries.</li>
<li>The radius of what constitutes a “single location” depends on the instrumentation and scientific question being asked.</li>
<li>Deriving location-based metadata from spatial datasets is computationally intensive unless saved and identified with a unique <code>locationID</code>.</li>
<li>Automated searches for spatial metadata occasionally produce incorrect results because of the non-infinite resolution of spatial datasets and must be corrected by hand.</li>
</ul>
</div>
<div id="functionality" class="section level2">
<h2 class="hasAnchor">
<a href="#functionality" class="anchor"></a>Functionality</h2>
<p>A solution to all these problems is possible if we store spatial metadata in simple tables in a standard directory. These tables will be referred to as <em>collections</em>. Location lookups can be performed with geodesic distance calculations where a location is assigned to a pre-existing <em>known location</em> if it is within <code>radius</code> meters. These will be extremely fast.</p>
<p>If no previously <em>known location</em> is found, the relatively slow (seconds) creation of a new <em>known location</em> metadata record can be performed and then added to the growing collection.</p>
<p>For collections of stationary environmental monitors that only number in the thousands, this entire <em>collection</em> (<em>i.e.</em> “database”) can be stored as either a <code>.rda</code> or <code>.csv</code> file and will be under a megabyte in size making it fast to load. This small size also makes it possible to store multiple <em>known location</em> files, each created with different locations and different radii to address the needs of different scientific studies.</p>
</div>
<div id="example-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#example-usage" class="anchor"></a>Example Usage</h2>
<p>The package comes with some example <em>known location</em> tables to demonstrate.</p>
<p>Lets take some metadata we have for air quality monitors in Washington state and create a <em>known location</em> table for them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wa &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"wa_airfire_meta"</span>, <span class="dt">package =</span> <span class="st">"MazamaLocationUtils"</span>))
<span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(wa)</code></pre></div>
<pre><code>##  [1] "monitorID"             "longitude"            
##  [3] "latitude"              "elevation"            
##  [5] "timezone"              "countryCode"          
##  [7] "stateCode"             "siteName"             
##  [9] "agencyName"            "countyName"           
## [11] "msaName"               "monitorType"          
## [13] "siteID"                "instrumentID"         
## [15] "aqsID"                 "pwfslID"              
## [17] "pwfslDataIngestSource" "telemetryAggregator"  
## [19] "telemetryUnitID"</code></pre>
<div id="creating-a-known-location-table" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-a-known-location-table" class="anchor"></a>Creating a Known Location table</h3>
<p>We can create a <em>known location</em> table for them with a minimum 500 meter separation between distinct locations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(MazamaLocationUtils)

<span class="co"># Initialize with standard directories</span>
<span class="kw"><a href="../reference/mazama_initialize.html">mazama_initialize</a></span>()
<span class="kw"><a href="../reference/setLocationDataDir.html">setLocationDataDir</a></span>(<span class="st">"./data"</span>)

wa_monitors_<span class="dv">500</span> &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/table_initialize.html">table_initialize</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/table_addLocation.html">table_addLocation</a></span>(wa<span class="op">$</span>longitude, wa<span class="op">$</span>latitude, <span class="dt">radius =</span> <span class="dv">500</span>) </code></pre></div>
<p>Right now, our <em>known locations</em> table contains only automatically generated spatial metadata:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(wa_monitors_<span class="dv">500</span>)</code></pre></div>
<pre><code>##  [1] "locationID"   "locationName" "longitude"    "latitude"    
##  [5] "elevation"    "countryCode"  "stateCode"    "county"      
##  [9] "timezone"     "houseNumber"  "street"       "city"        
## [13] "zip"</code></pre>
</div>
<div id="merging-external-metadata" class="section level3">
<h3 class="hasAnchor">
<a href="#merging-external-metadata" class="anchor"></a>Merging external metadata</h3>
<p>Perhaps we would like to import some of the original metadata into our new table. This is a very common use case where non-spatial metadata like site name or agency responsible for a monitor can be added.</p>
<p>Just to make it interesting, let’s assume that our <em>known location</em> table is already large and we are only providing additional metadata for a subset of the records.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Use a subset of the wa metadata</span>
wa_indices &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">5</span>,<span class="dv">65</span>,<span class="dv">5</span>)
wa_sub &lt;-<span class="st"> </span>wa[wa_indices,]

<span class="co"># Use a generic name for the location table</span>
locationTbl &lt;-<span class="st"> </span>wa_monitors_<span class="dv">500</span>

<span class="co"># Find the location IDs associated with our subset</span>
locationID &lt;-<span class="st"> </span><span class="kw"><a href="../reference/table_getLocationID.html">table_getLocationID</a></span>(
  locationTbl, 
  <span class="dt">longitude =</span> wa_sub<span class="op">$</span>longitude, 
  <span class="dt">latitude =</span> wa_sub<span class="op">$</span>latitude, 
  <span class="dt">radius =</span> <span class="dv">500</span>
)

<span class="co"># Now add the "siteName" column for our subset of locations</span>
locationData &lt;-<span class="st"> </span>wa_sub<span class="op">$</span>siteName
locationTbl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/table_updateColumn.html">table_updateColumn</a></span>(
  locationTbl, 
  <span class="dt">columnName =</span> <span class="st">"siteName"</span>, 
  <span class="dt">locationID =</span> locationID, 
  <span class="dt">locationData =</span> locationData
)

<span class="co"># Lets see how we did</span>
locationTbl_indices &lt;-<span class="st"> </span><span class="kw"><a href="../reference/table_getRecordIndex.html">table_getRecordIndex</a></span>(locationTbl, locationID)
locationTbl[locationTbl_indices, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"city"</span>, <span class="st">"siteName"</span>)]</code></pre></div>
<pre><code>## # A tibble: 13 x 2
##    city               siteName                    
##    &lt;chr&gt;              &lt;chr&gt;                       
##  1 Chelan             Chelan-Woodin Ave           
##  2 La Crosse          Lacrosse-Hill St            
##  3 Tri-Cities         Kennewick-Metaline          
##  4 Sunnyside          Sunnyside-S 16th            
##  5 Inchelium          Inchelium                   
##  6 Wellpinit          Wellpinit-Spokane Tribe     
##  7 Lake Forest Park   Lake Forest Park-Town Center
##  8 Okanogan County    Twisp-Glover St             
##  9 Limestone Junction Maple Falls-Azure Way       
## 10 Okanogan County    Omak-Colville Tribe         
## 11 Ritzville          "Ritzville-Alder St "       
## 12 Darrington         Darrington-Fir St           
## 13 Tukwila            Tukwila_Allentown</code></pre>
<p>Very nice.</p>
</div>
<div id="finding-known-locations" class="section level3">
<h3 class="hasAnchor">
<a href="#finding-known-locations" class="anchor"></a>Finding known locations</h3>
<p>The whole point of a know location table is to speed up access to spatial and other metadata. Here’s how we can use it with a set of longitudes and latitudes that are not currently in our table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create new locations near our known locations</span>
lons &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(wa_sub<span class="op">$</span>longitude) 
lats &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span>(wa_sub<span class="op">$</span>latitude)

<span class="co"># Any known locations within 50 meters?</span>
<span class="kw"><a href="../reference/table_getNearestLocation.html">table_getNearestLocation</a></span>(
  wa_monitors_<span class="dv">500</span>,
  <span class="dt">longitude =</span> lons,
  <span class="dt">latitude =</span> lats,
  <span class="dt">radius =</span> <span class="dv">50</span>
) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(city)</code></pre></div>
<pre><code>##  [1] NA          NA          NA          NA          NA         
##  [6] "Wellpinit" NA          NA          NA          NA         
## [11] NA          NA          NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Any known locations within 500 meters</span>
<span class="kw"><a href="../reference/table_getNearestLocation.html">table_getNearestLocation</a></span>(
  wa_monitors_<span class="dv">500</span>,
  <span class="dt">longitude =</span> lons,
  <span class="dt">latitude =</span> lats,
  <span class="dt">radius =</span> <span class="dv">500</span>
) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(city)</code></pre></div>
<pre><code>##  [1] "Chelan"           NA                 "Tri-Cities"      
##  [4] "Sunnyside"        "Inchelium"        "Wellpinit"       
##  [7] "Lake Forest Park" NA                 NA                
## [10] NA                 "Ritzville"        "Darrington"      
## [13] NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How about 5000 meters?</span>
<span class="kw"><a href="../reference/table_getNearestLocation.html">table_getNearestLocation</a></span>(
  wa_monitors_<span class="dv">500</span>,
  <span class="dt">longitude =</span> lons,
  <span class="dt">latitude =</span> lats,
  <span class="dt">radius =</span> <span class="dv">5000</span>
) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(city)</code></pre></div>
<pre><code>##  [1] "Chelan"             "La Crosse"          "Tri-Cities"        
##  [4] "Sunnyside"          "Inchelium"          "Wellpinit"         
##  [7] "Lake Forest Park"   "Okanogan County"    "Limestone Junction"
## [10] "Okanogan County"    "Ritzville"          "Darrington"        
## [13] "Tukwila"</code></pre>
</div>
</div>
<div id="standard-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#standard-setup" class="anchor"></a>Standard Setup</h2>
<p>Before using <strong>MazamaLocationUtils</strong> you must first install <strong>MazamaSpatialUtils</strong> and then install core spatial data with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(MazamaSpatialUtils)
  <span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/setSpatialDataDir.html">setSpatialDataDir</a></span>(<span class="st">"~/Data/Spatial"</span>)
  <span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/installSpatialData.html">installSpatialData</a></span>()</code></pre></div>
<p>Once the required datasets have been installed, the easiest way to set things up each session is with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(MazamaLocationUtils)
  <span class="kw"><a href="../reference/mazama_initialize.html">mazama_initialize</a></span>()
  <span class="kw"><a href="../reference/setLocationDataDir.html">setLocationDataDir</a></span>(<span class="st">"~/Data/KnownLocations"</span>)</code></pre></div>
<p><code><a href="../reference/mazama_initialize.html">mazama_initialize()</a></code> assumes spatial data are installed in the standard location and is just a wrapper for:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  MazamaSpatialUtils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/setSpatialDataDir.html">setSpatialDataDir</a></span>(<span class="st">"~/Data/Spatial"</span>)
  
  MazamaSpatialUtils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/loadSpatialData.html">loadSpatialData</a></span>(<span class="st">"EEZCountries"</span>)
  MazamaSpatialUtils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/loadSpatialData.html">loadSpatialData</a></span>(<span class="st">"OSMTimezones"</span>)
  MazamaSpatialUtils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/loadSpatialData.html">loadSpatialData</a></span>(<span class="st">"NaturalEarthAdm1"</span>)
  MazamaSpatialUtils<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/MazamaSpatialUtils/man/loadSpatialData.html">loadSpatialData</a></span>(<span class="st">"USCensusCounties"</span>)</code></pre></div>
<p>Every time you <code><a href="../reference/table_save.html">table_save()</a></code> your location table, a backup will be created so you can experiment without losing your work. File sizes are pretty tiny so you don’t have to worry about filling up your disk.</p>
<hr>
<p>Best wishes for well organized spatial metadata!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#background">Background</a></li>
      <li><a href="#functionality">Functionality</a></li>
      <li><a href="#example-usage">Example Usage</a></li>
      <li><a href="#standard-setup">Standard Setup</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
